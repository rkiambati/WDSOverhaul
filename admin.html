<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overhaul â€” Owner</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    .page {max-width: 960px; margin: 64px auto; padding: 0 16px;}
    table {width:100%; border-collapse: collapse;}
    th, td {border-bottom: 1px solid #1f2937; padding: 8px 6px; text-align: left;}
    .row {display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px}
    .card {background:#0b0f14;border:1px solid #1f2937;border-radius:16px;padding:16px}
  </style>
</head>
<body>
  <div class="page">
    <h1>Owner view</h1>
    <div id="gate" class="card">
      <p>Enter passphrase to view entries.</p>
      <input id="pw" type="password" placeholder="Passphrase" />
      <button id="go" class="btn btn-primary">Unlock</button>
      <p class="note" style="opacity:.8">Tip: change the passphrase and hash in the script before pushing.</p>
    </div>

    <div id="app" hidden>
      <div class="row">
        <button class="btn" id="exp-wl">Export waitlist CSV</button>
        <button class="btn" id="exp-sp">Export sponsors CSV</button>
        <button class="btn" id="clear">Clear local data</button>
      </div>

      <h2>Waitlist</h2>
      <div class="card">
        <table id="tbl-wl"></table>
      </div>

      <h2>Sponsors</h2>
      <div class="card">
        <table id="tbl-sp"></table>
      </div>
    </div>
  </div>

<script src="./assets/forms.js"></script>
<script>
  // Owner hash is stored once in localStorage as hex
  const KEY = "wds_owner_hash_hex";

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  // Setup UI: if no hash stored, let owner set one
  const gate = document.getElementById('gate');
  const app  = document.getElementById('app');

  const setupRow = document.createElement('div');
  setupRow.innerHTML = `
    <p class="note">No owner passphrase set yet. Create one now.</p>
    <input id="newpw" type="password" placeholder="New passphrase" />
    <button id="setpw" class="btn btn-primary">Set passphrase</button>
  `;

  if(!localStorage.getItem(KEY)){
    gate.appendChild(setupRow);
    document.getElementById('setpw').onclick = async () => {
      const pw = document.getElementById('newpw').value.trim();
      if(!pw) return alert("Enter a passphrase");
      localStorage.setItem(KEY, await sha256Hex(pw));
      alert("Passphrase set. Use it to unlock below.");
      setupRow.remove();
    };
  }

  document.getElementById('go').addEventListener('click', async () => {
    const inputHex = await sha256Hex(document.getElementById('pw').value);
    const savedHex = localStorage.getItem(KEY);
    if(!savedHex){ return alert("No passphrase set yet."); }
    if(inputHex !== savedHex){ alert("Wrong passphrase"); return; }
    gate.hidden = true; app.hidden = false; render();
  });

  function render(){
    const wl = loadEntries('waitlist');
    const sp = loadEntries('sponsors');
    renderTable('tbl-wl', wl);
    renderTable('tbl-sp', sp);
    document.getElementById('exp-wl').onclick = () => downloadCSV(`waitlist-${new Date().toISOString().slice(0,10)}.csv`, wl);
    document.getElementById('exp-sp').onclick = () => downloadCSV(`sponsors-${new Date().toISOString().slice(0,10)}.csv`, sp);
    document.getElementById('clear').onclick = () => {
      if(confirm("Clear all local entries on this device?")){
        localStorage.removeItem("wds_waitlist_entries_v1");
        localStorage.removeItem("wds_sponsor_entries_v1");
        render();
      }
    };
  }

  function renderTable(id, rows){
    const el = document.getElementById(id);
    if(!rows.length){ el.innerHTML = "<tr><td>No entries yet</td></tr>"; return; }
    const headers = Object.keys(rows[0]);
    el.innerHTML =
      "<thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead>"+
      "<tbody>"+rows.map(r=>"<tr>"+headers.map(h=>`<td>${r[h]??""}</td>`).join("")+"</tr>").join("")+"</tbody>";
  }
</script>

</body>
</html>
