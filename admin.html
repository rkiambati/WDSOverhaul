<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overhaul â€” Owner</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    .page {max-width: 960px; margin: 64px auto; padding: 0 16px;}
    table {width:100%; border-collapse: collapse;}
    th, td {border-bottom: 1px solid #1f2937; padding: 8px 6px; text-align: left;}
    .row {display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px}
    .card {background:#0b0f14;border:1px solid #1f2937;border-radius:16px;padding:16px}
  </style>
</head>
<body>
  <div class="page">
    <h1>Owner view</h1>
    <div id="gate" class="card">
      <p>Enter passphrase to view entries.</p>
      <input id="pw" type="password" placeholder="Passphrase" />
      <button id="go" class="btn btn-primary">Unlock</button>
      <p class="note" style="opacity:.8">Tip: change the passphrase and hash in the script before pushing.</p>
    </div>

    <div id="app" hidden>
      <div class="row">
        <button class="btn" id="exp-wl">Export waitlist CSV</button>
        <button class="btn" id="exp-sp">Export sponsors CSV</button>
        <button class="btn" id="clear">Clear local data</button>
      </div>

      <h2>Waitlist</h2>
      <div class="card">
        <table id="tbl-wl"></table>
      </div>

      <h2>Sponsors</h2>
      <div class="card">
        <table id="tbl-sp"></table>
      </div>
    </div>
  </div>

<script src="./assets/forms.js"></script>
<script>
  // Owner view fetches CSV via /api/list with ADMIN_KEY
  const qs = new URLSearchParams(location.search);
  let OWNER_KEY = ""; // set after unlocking

  function csvToRows(csv){
    if (!csv.trim()) return [];
    const lines = csv.split(/\r?\n/);
    const rows = [];
    for (const line of lines){
      if (line === "") continue;
      const cells = line.match(/("([^"]|"")*"|[^,]*)/g).filter(Boolean)
        .map(s => s.replace(/^"|"$/g,"").replace(/""/g,'"'));
      rows.push(cells);
    }
    return rows;
  }
  async function fetchCSV(kind){
    const r = await fetch(`/api/list?kind=${kind}&key=${encodeURIComponent(OWNER_KEY)}`, { cache:"no-store" });
    if (!r.ok) throw new Error(`${kind} ${r.status} ${await r.text()}`);
    return await r.text();
  }
  function renderTable(id, rows){
    const el = document.getElementById(id);
    if (!rows.length || rows.length === 1){ el.innerHTML = "<tr><td>No entries yet</td></tr>"; return; }
    const head = "<thead><tr>"+rows[0].map(h=>`<th>${h}</th>`).join("")+"</tr></thead>";
    const body = "<tbody>"+rows.slice(1).map(r=>"<tr>"+r.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("")+"</tbody>";
    el.innerHTML = head + body;
  }

  // Gate UI 
  const gate = document.getElementById('gate');
  const app  = document.getElementById('app');
  document.getElementById('go').addEventListener('click', async () => {
    OWNER_KEY = document.getElementById('pw').value.trim();
    if (!OWNER_KEY){ alert("Enter passphrase"); return; }
    try{
      // quick ping to verify
      await fetchCSV('waitlist');
      gate.hidden = true; app.hidden = false;
      render();
    }catch(e){ alert("Wrong passphrase or server error"); }
  });

  async function render(){
    try{
      const wlCSV = await fetchCSV('waitlist');
      const spCSV = await fetchCSV('sponsor');
      const wl = csvToRows(wlCSV), sp = csvToRows(spCSV);
      renderTable('tbl-wl', wl);
      renderTable('tbl-sp', sp);

      document.getElementById('exp-wl').onclick = () => downloadCSV('waitlist.csv', wl.map(r=>Object.fromEntries(wl[0].map((h,i)=>[h,r[i]]))).slice(1));
      document.getElementById('exp-sp').onclick = () => downloadCSV('sponsors.csv', sp.map(r=>Object.fromEntries(sp[0].map((h,i)=>[h,r[i]]))).slice(1));
      document.getElementById('clear').onclick = () => alert("Server-backed storage: nothing to clear locally.");
    }catch(e){
      console.error(e);
      alert("Could not load data. Check ADMIN_KEY and try again.");
    }
  }


  function downloadCSV(filename, rows){
    if (!rows.length) return;
    const headers = Object.keys(rows[0]);
    const esc = v => `"${String(v ?? "").replace(/"/g,'""')}"`;
    const csv = [headers.join(",")].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(","))).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
